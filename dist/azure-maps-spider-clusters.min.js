/* MIT License - Copyright (c) Microsoft Corporation. */


!function(e,g){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var v,t,i,a=(v=g.internal.EventEmitter,r(t=n,i=v),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s),n.prototype.dispose=function(){var e=this,t=e._map,r=t.events,i=e._spiderFeatureLayer,a=e._layerClickEvent,s=e.hideSpiderCluster;r.remove("click",s),r.remove("movestart",s),r.remove("click",e._clusterLayer,a),r.remove("mouseleave",i,e._unhighlightStick),r.remove("mousemove",i,e._highlightStick),r.remove("click",i,a),r.remove("click",e._unclustedLayer,a),t.layers.remove(i),e._spiderFeatureLayer=null,t.layers.remove(e._spiderLineLayer),e._spiderLineLayer=null,e._spiderDataSource.clear(),t.sources.remove(e._spiderDataSource),e._spiderDataSource=null},n.prototype.getOptions=function(){return JSON.parse(JSON.stringify(this._options))},n.prototype.getLayers=function(){var e=this;return{clusterLayer:e._clusterLayer,unclustedLayer:e._unclustedLayer,spiderFeatureLayer:e._spiderFeatureLayer,spiderLineLayer:e._spiderLineLayer}},n.prototype.setOptions=function(e){var t=this,r=t._options;this.hideSpiderCluster(),e&&("number"==typeof e.circleSpiralSwitchover&&(r.circleSpiralSwitchover=e.circleSpiralSwitchover),"number"==typeof e.maxFeaturesInWeb&&(r.maxFeaturesInWeb=e.maxFeaturesInWeb),"number"==typeof e.minSpiralAngleSeperation&&(r.minSpiralAngleSeperation=e.minSpiralAngleSeperation),"number"==typeof e.spiralDistanceFactor&&(r.spiralDistanceFactor=e.spiralDistanceFactor),"number"==typeof e.minCircleLength&&(r.minCircleLength=e.minCircleLength),e.stickLayerOptions&&(r.stickLayerOptions=e.stickLayerOptions,t._spiderLineLayer.setOptions(e.stickLayerOptions)),"boolean"==typeof e.visible&&r.visible!==e.visible&&(r.visible=e.visible,t._spiderLineLayer.setOptions({visible:e.visible}),t._spiderFeatureLayer.setOptions({visible:e.visible})))},n.prototype.showSpiderCluster=function(_){var y=this,S=this,m=S._options;S.hideSpiderCluster(),_&&_.properties.cluster&&S._datasource.getClusterLeaves(_.properties.cluster_id,m.maxFeaturesInWeb,0).then(function(e){var t,r,i,a=_.geometry.coordinates,s=S._map.positionsToPixels([a])[0],n=0,o=e.length>m.circleSpiralSwitchover;o?(t=m.minCircleLength/Math.PI,i=2*Math.PI*m.spiralDistanceFactor):(r=2*Math.PI/e.length,(t=m.spiralDistanceFactor/r/Math.PI/2*e.length)<m.minCircleLength&&(t=m.minCircleLength));for(var c=[],p=0,l=e.length;p<l;p++){o?t+=i/(n+=m.minSpiralAngleSeperation/t+5e-4*p):n=r*p;var u=S._map.pixelsToPositions([[s[0]+t*Math.cos(n),s[1]+t*Math.sin(n)]])[0];c.push(new g.data.Feature(new g.data.LineString([a,u]),null,p+""));var d=e[p],h=d instanceof g.Shape?d.getId():d.id,v=Object.assign({},d instanceof g.Shape?d.getProperties():d.properties);v._stickId=p+"",v._parentId=h,c.push(new g.data.Feature(new g.data.Point(u),v))}y._spiderDataSource.add(c)})},n);function s(){this.constructor=t}function n(e,t,r,i){var n=v.call(this)||this;n._hoverStateId=null,n._options={circleSpiralSwitchover:6,minCircleLength:30,minSpiralAngleSeperation:25,spiralDistanceFactor:5,maxFeaturesInWeb:100,stickLayerOptions:{strokeColor:["case",["boolean",["feature-state","hover"],!1],"red","black"]}},n.hideSpiderCluster=function(){n._spiderDataSource.clear()},n._layerClickEvent=function(e){var t=n;if(e&&e.shapes&&0<e.shapes.length){var r,i=void 0,a=void 0,s=void 0;r=e.shapes[0]instanceof g.Shape?(i=(a=e.shapes[0]).getProperties(),a.getCoordinates()):(i=(s=e.shapes[0]).properties,s.geometry.coordinates),s&&i.cluster?(t._invokeEvent("featureUnselected",null),t._currentCluster=e.shapes[0],i.point_count>t._options.maxFeaturesInWeb?t._datasource.getClusterExpansionZoom(i.cluster_id).then(function(e){t._map.setCamera({center:r,zoom:e})}):t.showSpiderCluster(s)):(void 0!==i._parentId?a=t._datasource.getShapeById(i._parentId):t._currentCluster=null,a&&t._invokeEvent("featureSelected",{cluster:t._currentCluster,shape:a}),t.hideSpiderCluster()),e.preventDefault()}},n._highlightStick=function(e){var t=n;if(e&&e.shapes&&0<e.shapes.length){var r=void 0;r=e.shapes[0]instanceof g.Shape?e.shapes[0].getProperties()._stickId:e.shapes[0].properties._stickId;var i={source:t._spiderDatasourceId,id:t._hoverStateId},a=t._map;t._hoverStateId&&a.map.setFeatureState(i,{hover:!1}),t._hoverStateId=r,i.id=r,a.map.setFeatureState(i,{hover:!0}),a.getCanvasContainer().style.cursor="pointer"}},n._unhighlightStick=function(e){var t=n;t._hoverStateId&&(t._map.map.setFeatureState({source:t._spiderDatasourceId,id:t._hoverStateId},{hover:!1}),t._hoverStateId=null,t._map.getCanvasContainer().style.cursor="grab")};var a=n,s=g.layer;a._map=e;var o=(a._clusterLayer=t).getSource();if("string"==typeof o&&(o=e.sources.getById(o)),!(o instanceof g.source.DataSource))throw"Data source on cluster layer is not supported.";a._datasource=o,i=i||{};var c=new g.source.DataSource;a._spiderDataSource=c,e.sources.add(c),a._spiderDatasourceId=c.getId(),a._spiderLineLayer=new s.LineLayer(c,null,a._options.stickLayerOptions),e.layers.add(a._spiderLineLayer);var p,l=Object.assign({},r.getOptions());l.source=void 0,l.filter=["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],p=(a._unclustedLayer=r)instanceof s.BubbleLayer?new s.BubbleLayer(c,null,l):(l.iconOptions=l.iconOptions||{},Object.assign(l.iconOptions,{allowOverlap:!0,ignorePlacement:!0}),new s.SymbolLayer(c,null,l)),a._spiderFeatureLayer=p,e.layers.add(p),a.setOptions(i);var u=e.events,d=a._layerClickEvent,h=a.hideSpiderCluster;return u.add("click",h),u.add("movestart",h),u.add("mouseleave",p,a._unhighlightStick),u.add("mousemove",p,a._highlightStick),u.add("click",t,d),u.add("click",p,d),u.add("click",r,d),n}e.SpiderClusterManager=a}(this.atlas=this.atlas||{},atlas);
